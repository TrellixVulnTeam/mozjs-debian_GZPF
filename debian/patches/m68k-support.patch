From: John Paul Adrian Glaubitz <glaubitz@physik.fu-berlin.de>
Date: Wed, 11 Jul 2018 12:58:00 +0200
Subject: Add support for m68k

Based on the patches sent to Firefox upstream.

Bug: https://bugzilla.mozilla.org/show_bug.cgi?id=1325771
Last-Update: 2018-07-11
---
 build/moz.configure/init.configure                               | 3 +++
 js/src/gc/Heap.h                                                 | 2 +-
 js/src/jit/AtomicOperations.h                                    | 2 ++
 js/src/jsfriendapi.h                                             | 2 +-
 mfbt/double-conversion/utils.h                                   | 2 ++
 mfbt/tests/TestPair.cpp                                          | 9 +++++++--
 mfbt/tests/TestPoisonArea.cpp                                    | 3 +++
 python/mozbuild/mozbuild/configure/constants.py                  | 2 ++
 .../mozbuild/mozbuild/test/configure/test_toolchain_configure.py | 2 ++
 9 files changed, 23 insertions(+), 4 deletions(-)

diff --git a/build/moz.configure/init.configure b/build/moz.configure/init.configure
index 6fa9ac4..2f7486f 100644
--- a/build/moz.configure/init.configure
+++ b/build/moz.configure/init.configure
@@ -383,6 +383,9 @@ def split_triplet(triplet):
     elif cpu == 'sh4':
         canonical_cpu = 'sh4'
         endianness = 'little'
+    elif cpu == 'm68k':
+        canonical_cpu = 'm68k'
+        endianness = 'big'
     else:
         die('Unknown CPU type: %s' % cpu)
 
diff --git a/js/src/gc/Heap.h b/js/src/gc/Heap.h
index 2a9390e..4e08bc9 100644
--- a/js/src/gc/Heap.h
+++ b/js/src/gc/Heap.h
@@ -282,7 +282,7 @@ struct Cell
   protected:
     inline uintptr_t address() const;
     inline Chunk* chunk() const;
-} JS_HAZ_GC_THING;
+} JS_HAZ_GC_THING __attribute__ ((aligned(4)));
 
 // A GC TenuredCell gets behaviors that are valid for things in the Tenured
 // heap, such as access to the arena and mark bits.
diff --git a/js/src/jit/AtomicOperations.h b/js/src/jit/AtomicOperations.h
index a3e44ea..13617ee 100644
--- a/js/src/jit/AtomicOperations.h
+++ b/js/src/jit/AtomicOperations.h
@@ -326,6 +326,8 @@ AtomicOperations::isLockfree(int32_t size)
 # include "jit/arm64/AtomicOperations-arm64.h"
 #elif defined(JS_CODEGEN_MIPS32) || defined(JS_CODEGEN_MIPS64)
 # include "jit/mips-shared/AtomicOperations-mips-shared.h"
+#elif defined(__m68k__)
+# include "jit/none/AtomicOperations-ppc.h"
 #elif defined(__ppc__) || defined(__PPC__)
 # include "jit/none/AtomicOperations-ppc.h"
 #elif defined(__sh__)
diff --git a/js/src/jsfriendapi.h b/js/src/jsfriendapi.h
index b1c7cb0..2b6b956 100644
--- a/js/src/jsfriendapi.h
+++ b/js/src/jsfriendapi.h
@@ -571,7 +571,7 @@ public:
     uint32_t          slotInfo;
 
     static const uint32_t FIXED_SLOTS_SHIFT = 27;
-};
+} __attribute__ ((aligned(4)));
 
 /**
  * This layout is shared by all native objects. For non-native objects, the
diff --git a/mfbt/double-conversion/utils.h b/mfbt/double-conversion/utils.h
index 15dd4bf..eaaaa45 100644
--- a/mfbt/double-conversion/utils.h
+++ b/mfbt/double-conversion/utils.h
@@ -69,6 +69,8 @@
 #else
 #undef DOUBLE_CONVERSION_CORRECT_DOUBLE_OPERATIONS
 #endif  // _WIN32
+#elif defined(__m68k__)
+#undef DOUBLE_CONVERSION_CORRECT_DOUBLE_OPERATIONS
 #else
 #error Target architecture was not detected as supported by Double-Conversion.
 #endif
diff --git a/mfbt/tests/TestPair.cpp b/mfbt/tests/TestPair.cpp
index f1fa9c5..41b463a 100644
--- a/mfbt/tests/TestPair.cpp
+++ b/mfbt/tests/TestPair.cpp
@@ -29,14 +29,19 @@ using mozilla::Pair;
   static_assert(sizeof(name##_2) == (size), \
                 "Pair<" #T2 ", " #T1 "> has an unexpected size");
 
+static constexpr size_t sizemax(size_t a, size_t b)
+{
+  return (a > b) ? a : b;
+}
+
 INSTANTIATE(int, int, prim1, 2 * sizeof(int));
-INSTANTIATE(int, long, prim2, 2 * sizeof(long));
+INSTANTIATE(int, long, prim2, sizeof(long) + sizemax(sizeof(int), alignof(long)));
 
 struct EmptyClass { explicit EmptyClass(int) {} };
 struct NonEmpty { char mC; explicit NonEmpty(int) {} };
 
 INSTANTIATE(int, EmptyClass, both1, sizeof(int));
-INSTANTIATE(int, NonEmpty, both2, 2 * sizeof(int));
+INSTANTIATE(int, NonEmpty, both2, sizeof(int) + alignof(int));
 INSTANTIATE(EmptyClass, NonEmpty, both3, 1);
 
 struct A { char dummy; explicit A(int) {} };
diff --git a/mfbt/tests/TestPoisonArea.cpp b/mfbt/tests/TestPoisonArea.cpp
index 76af23f..1876b6e 100644
--- a/mfbt/tests/TestPoisonArea.cpp
+++ b/mfbt/tests/TestPoisonArea.cpp
@@ -133,6 +133,9 @@
 #elif defined _ARCH_PPC || defined _ARCH_PWR || defined _ARCH_PWR2
 #define RETURN_INSTR 0x4E800020 /* blr */
 
+#elif defined __m68k__
+#define RETURN_INSTR 0x4E754E75 /* rts; rts */
+
 #elif defined __sparc || defined __sparcv9
 #define RETURN_INSTR 0x81c3e008 /* retl */
 
diff --git a/python/mozbuild/mozbuild/configure/constants.py b/python/mozbuild/mozbuild/configure/constants.py
index 668713f..056ac45 100644
--- a/python/mozbuild/mozbuild/configure/constants.py
+++ b/python/mozbuild/mozbuild/configure/constants.py
@@ -44,6 +44,7 @@ CPU_bitness = {
     'arm': 32,
     'hppa': 32,
     'ia64': 64,
+    'm68k': 32,
     'mips32': 32,
     'mips64': 64,
     'ppc': 32,
@@ -87,6 +88,7 @@ CPU_preprocessor_checks = OrderedDict((
     ('mips64', '__mips64'),
     ('mips32', '__mips__'),
     ('sh4', '__sh__'),
+    ('m68k', '__m68k__'),
 ))
 
 assert sorted(CPU_preprocessor_checks.keys()) == sorted(CPU.POSSIBLE_VALUES)
diff --git a/python/mozbuild/mozbuild/test/configure/test_toolchain_configure.py b/python/mozbuild/mozbuild/test/configure/test_toolchain_configure.py
index 77b24e9..ed40c39 100644
--- a/python/mozbuild/mozbuild/test/configure/test_toolchain_configure.py
+++ b/python/mozbuild/mozbuild/test/configure/test_toolchain_configure.py
@@ -1039,6 +1039,8 @@ class LinuxCrossCompileToolchainTest(BaseToolchainTest):
         },
         'sh4-unknown-linux-gnu': little_endian + {
             '__sh__': 1,
+        'm68k-unknown-linux-gnu': big_endian + {
+            '__m68k__': 1,
         },
     }
 
